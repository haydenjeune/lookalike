import pytest
import requests_mock
from lib.image.retrieve import WikipediaImageRetriever


@pytest.fixture
def test_gene_wilder_html():
    return r'<!DOCTYPE html><html class="client-nojs" lang="en" dir="ltr"><table class="infobox biography vcard" style="width:22em"><tbody><tr><th colspan="2" style="text-align:center;font-size:125%;font-weight:bold"><div class="fn" style="display:inline">Gene Wilder</div></th></tr><tr><td colspan="2" style="text-align:center"><a href="/wiki/File:Gene_Wilder_1970.JPG" class="image" title="A black-and-white photo of Wilder smiling"><img alt="A black-and-white photo of Wilder smiling" src="//upload.wikimedia.org/wikipedia/commons/thumb/9/9e/Gene_Wilder_1970.JPG/220px-Gene_Wilder_1970.JPG" decoding="async" width="220" height="278" srcset="//upload.wikimedia.org/wikipedia/commons/thumb/9/9e/Gene_Wilder_1970.JPG/330px-Gene_Wilder_1970.JPG 1.5x, //upload.wikimedia.org/wikipedia/commons/thumb/9/9e/Gene_Wilder_1970.JPG/440px-Gene_Wilder_1970.JPG 2x" data-file-width="711" data-file-height="900" /></a><div>Wilder in 1970</div></td></tr><tr><th scope="row">Born</th><td><div style="display:inline" class="nickname">Jerome Silberman</div><br /><span style="display:none">(<span class="bday">1933-06-11</span>)</span>June 11, 1933<br /><div style="display:inline" class="birthplace"><a href="/wiki/Milwaukee,_Wisconsin" class="mw-redirect" title="Milwaukee, Wisconsin">Milwaukee, Wisconsin</a>, U.S.</div></td></tr><tr><th scope="row">Died</th><td>August 29, 2016<span style="display:none">(2016-08-29)</span> (aged&#160;83)<br /><div style="display:inline" class="deathplace"><a href="/wiki/Stamford,_Connecticut" title="Stamford, Connecticut">Stamford, Connecticut</a>, U.S.</div></td></tr><tr><th scope="row">Alma&#160;mater</th><td><div class="plainlist"><ul><li><a href="/wiki/University_of_Iowa" title="University of Iowa">University of Iowa</a> (<a href="/wiki/B.A." class="mw-redirect" title="B.A.">B.A.</a>, 1955)</li><li><a href="/wiki/Bristol_Old_Vic_Theatre_School" title="Bristol Old Vic Theatre School">Bristol Old Vic Theatre School</a></li></ul></div></td></tr><tr><th scope="row">Occupation</th><td class="role">Actor, writer, filmmaker</td></tr><tr><th scope="row">Years&#160;active</th><td><div class="plainlist"><ul><li>1961–2005 (actor)</li><li>1998–2013 (author)</li></ul></div></td></tr><tr><th scope="row"><span class="nowrap">Spouse(s)</span></th><td><div class="plainlist"><ul><li><div style="display:inline;white-space:nowrap;"><div style="display:inline-block;line-height:normal;margin-top:1px;white-space:normal;">Mary Mercier</div><div style="line-height:0;margin-bottom:-2px;">&#8203;</div>&#32;<div style="display:inline-block;margin-bottom:1px;">&#8203;</div>&#40;<abbr title="married">m.</abbr>&#160;1960&#59;&#32;<abbr title="divorced">div.</abbr>&#160;1965&#41;<wbr />&#8203;</div></li><li><div style="display:inline;white-space:nowrap;"><div style="display:inline-block;line-height:normal;margin-top:1px;white-space:normal;">Mary Joan Schutz</div><div style="line-height:0;margin-bottom:-2px;">&#8203;</div>&#32;<div style="display:inline-block;margin-bottom:1px;">&#8203;</div>&#40;<abbr title="married">m.</abbr>&#160;1967&#59;&#32;<abbr title="divorced">div.</abbr>&#160;1974&#41;<wbr />&#8203;</div></li><li><div style="display:inline;white-space:nowrap;"><div style="display:inline-block;line-height:normal;margin-top:1px;white-space:normal;"><a href="/wiki/Gilda_Radner" title="Gilda Radner">Gilda Radner</a></div><div style="line-height:0;margin-bottom:-2px;">&#8203;</div>&#32;<div style="display:inline-block;margin-bottom:1px;">&#8203;</div>&#40;<abbr title="married">m.</abbr>&#160;1984&#59;&#32;died&#160;1989&#41;<wbr />&#8203;</div></li><li><div style="display:inline;white-space:nowrap;"><div style="display:inline-block;line-height:normal;">Karen Boyer</div>&#32;<div style="display:inline-block;">&#8203;</div>&#40;<abbr title="married">m.</abbr>&#160;1991&#41;<wbr />&#8203;</div></li></ul></div></td></tr><tr><th scope="row">Children</th><td>1</td></tr><tr><th scope="row">Relatives</th><td><a href="/wiki/Jordan_Walker-Pearlman" title="Jordan Walker-Pearlman">Jordan Walker-Pearlman</a> (nephew)</td></tr><tr><th colspan="2" style="text-align:center">Signature</th></tr><tr><td colspan="2" style="text-align:center"><a href="/wiki/File:Gene_Wilder_(signature).png" class="image"><img alt="Gene Wilder (signature).png" src="//upload.wikimedia.org/wikipedia/commons/thumb/1/19/Gene_Wilder_%28signature%29.png/150px-Gene_Wilder_%28signature%29.png" decoding="async" width="150" height="56" srcset="//upload.wikimedia.org/wikipedia/commons/thumb/1/19/Gene_Wilder_%28signature%29.png/225px-Gene_Wilder_%28signature%29.png 1.5x, //upload.wikimedia.org/wikipedia/commons/thumb/1/19/Gene_Wilder_%28signature%29.png/300px-Gene_Wilder_%28signature%29.png 2x" data-file-width="713" data-file-height="268" /></a></td></tr></tbody></table></html>'


@pytest.fixture
def test_khloe_kardashian_html():
    return r'<!DOCTYPE html><html class="client-nojs" lang="en" dir="ltr"><table class="infobox biography vcard" style="width:22em"><tbody><tr><th colspan="2" style="text-align:center;font-size:125%;font-weight:bold"><div class="fn" style="display:inline">Khloé Kardashian</div></th></tr><tr><td colspan="2" style="text-align:center"><a href="/wiki/File:Khloe_Kardashian_Glamour_2.png" class="image"><img alt="Khloe Kardashian Glamour 2.png" src="//upload.wikimedia.org/wikipedia/commons/thumb/0/01/Khloe_Kardashian_Glamour_2.png/220px-Khloe_Kardashian_Glamour_2.png" decoding="async" width="220" height="306" srcset="//upload.wikimedia.org/wikipedia/commons/thumb/0/01/Khloe_Kardashian_Glamour_2.png/330px-Khloe_Kardashian_Glamour_2.png 1.5x, //upload.wikimedia.org/wikipedia/commons/thumb/0/01/Khloe_Kardashian_Glamour_2.png/440px-Khloe_Kardashian_Glamour_2.png 2x" data-file-width="643" data-file-height="894" /></a><div>Kardashian in June 2016</div></td></tr><tr><th scope="row">Born</th><td><div style="display:inline" class="nickname">Khloé Alexandra Kardashian</div><br /><span style="display:none"> (<span class="bday">1984-06-27</span>) </span>June 27, 1984<span class="noprint ForceAgeToShow"> (age&#160;36)</span><br /><div style="display:inline" class="birthplace"><a href="/wiki/Los_Angeles" title="Los Angeles">Los Angeles</a>, <a href="/wiki/California" title="California">California</a>, U.S.</div></td></tr><tr><th scope="row">Other&#160;names</th><td class="nickname">KOKO, Khloé Kardashian Odom<sup id="cite_ref-about1_1-0" class="reference"><a href="#cite_note-about1-1">&#91;1&#93;</a></sup><sup id="cite_ref-ivillage.com_2-0" class="reference"><a href="#cite_note-ivillage.com-2">&#91;2&#93;</a></sup></td></tr><tr><th scope="row">Education</th><td><a href="/wiki/Marymount_High_School" title="Marymount High School">Marymount High School</a></td></tr><tr><th scope="row">Occupation</th><td class="role"><div class="hlist hlist-separated"><ul><li>Media personality</li><li>socialite</li><li>model</li></ul></div></td></tr><tr><th scope="row">Years&#160;active</th><td>2007–present</td></tr><tr><th scope="row"><span class="nowrap">Spouse(s)</span></th><td><div style="display:inline;white-space:nowrap;"><div style="display:inline-block;line-height:normal;margin-top:1px;white-space:normal;"><a href="/wiki/Lamar_Odom" title="Lamar Odom">Lamar Odom</a></div><div style="line-height:0;margin-bottom:-2px;">&#8203;</div>&#32;<div style="display:inline-block;margin-bottom:1px;">&#8203;</div>&#40;<abbr title="married">m.</abbr>&#160;2009&#59;&#32;<abbr title="divorced">div.</abbr>&#160;2016&#41;<wbr />&#8203;</div></td></tr><tr><th scope="row"><span class="nowrap">Partner(s)</span></th><td><a href="/wiki/Tristan_Thompson" title="Tristan Thompson">Tristan Thompson</a><br />(2016–present)</td></tr><tr><th scope="row">Children</th><td>1</td></tr><tr><th scope="row">Parent(s)</th><td><div class="plainlist"><ul><li><a href="/wiki/Robert_Kardashian" title="Robert Kardashian">Robert Kardashian</a> (father)</li><li><a href="/wiki/Kris_Jenner" title="Kris Jenner">Kris Jenner</a> (mother)</li></ul></div></td></tr><tr><th scope="row">Relatives</th><td><a href="/wiki/Kardashian_family" title="Kardashian family">Kardashian family</a></td></tr><tr><th scope="row">Website</th><td><span class="url"><a rel="nofollow" class="external text" href="http://khloewithak.com">khloewithak<wbr />.com</a></span></td></tr></tbody></table></html>'


def test_find_image_page_url_finds_gene_wilder_image(test_gene_wilder_html):
    sut = WikipediaImageRetriever()

    links = set(sut._find_image_page_urls(test_gene_wilder_html))
    assert "https://en.wikipedia.org/wiki/File:Gene_Wilder_1970.JPG" in links
    assert "https://en.wikipedia.org/wiki/File:Gene_Wilder_(signature).png" in links
    assert len(links) == 2


def test_find_image_page_url_finds_khloe_kardashian_image(test_khloe_kardashian_html):
    sut = WikipediaImageRetriever()

    links = set(sut._find_image_page_urls(test_khloe_kardashian_html))
    assert "https://en.wikipedia.org/wiki/File:Khloe_Kardashian_Glamour_2.png" in links
    assert len(links) == 1