containers:
  build-env:
    build_directory: .
    dockerfile: infrastructure/docker/build-env.Dockerfile
    volumes:
      - type: cache
        name: cache
        container: /root/.cache
      - local: .
        container: /code
        options: cached
    working_directory: /code

tasks:
  shell:
    description: Open a shell in the dev environment
    run:
      container: build-env
      command: bash
  compile-python-deps:
    description: Compiles the requirements.in to a requirements.txt file
    run:
      container: build-env
      command: pip-compile requirements.in -q -o 3rdparty/python/requirements.txt --cache-dir /root/.cache/pip-compile
  build-api:
    description: Builds the api with Pants
    prerequisites:
      - compile-python-deps
    run:
      container: build-env
      command: ./pants package src/api
